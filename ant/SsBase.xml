<?xml version="1.0" encoding="GBK"?>
<project name="sindosoft_basic" default="main" basedir=".">
	<property environment="env"/>
	<property name="workDir" value="${env.WORK_DIR}" />
	<property name="antExtDir" value="${basedir}/../jar" />

	<path id="AntExtLib">
		<fileset dir="${antExtDir}" includes="AntExt.jar"/>
		<fileset dir="${antExtDir}" includes="OpenFrm.jar"/>
	</path>
	
	<taskdef resource="com/asiainfo/tools/ant/antlib.xml" classpathref="AntExtLib"/>
	
	<target name="init">
		<condition property="realPswd" value="${env.alasPswd}" else="${userPswd}">
			<equals arg1="${userPswd}" arg2="default" casesensitive="true"/>
		</condition>
		<condition property="shadowName" value="${argShadowName}" else="${hostName}">
			<isset property="argShadowName" />
		</condition>
		<condition property="shadowName_" value="${argShadowName}_" else="${hostName}_">
			<isset property="argShadowName" />
		</condition>
		<input message="请选择用户ID>" addproperty="inputSsUser"/>
		
		<echo></echo>
		<echo>输入信息:{shadowName:${shadowName}, ssUser:${inputSsUser}}.</echo>
	</target>
	
	<target name="info" depends="init">
		<loadfile property="jsonFileContent" srcFile="${workDir}/${hostDir}/${shadowName}${inputSsUser}.json"/>

		<echo>
感谢您选用可靠又快速的AlaSS，正式账号完整配置信息如下:

${jsonFileContent}

中英对照：
　　服务器 IP  &lt;=&gt; server
　　服务器端口 &lt;=&gt; server_port
　　密码       &lt;=&gt; password
　　加密       &lt;=&gt; method
　　代理端口   &lt;=&gt; local_port

注意事项：
	为了合租主机上其他用户的上网体验，特做如下要求：
	1)每人每月600G，以防有人滥用; 
	2)限定1个账号最多3个设备同时上网，以防太多人共用账号(多主机共用路由器上网算1个设备);
	3)不得通过本SS账号下载盗版软件，盗版电影，以防服务器被告侵权，从而被关闭

售后服务：
	请加入我们的售后服务企鹅群: 387477811；
	您也可以关注我们的官方网站，http://www.alafafa.com；
	服务器如有异动，我们会在在以上地方同步发布公告信息。
		</echo>

	</target>
	
	<target name="runall" depends="init">
		<echo>run all shadowsocks service on ${hostAddr}</echo>
		
		<!-- 
		start-sss.sh:
				cd ~sindo/shadowsocks
				ls *.json|cut -d. -f1|awk  '{print "nohup /usr/local/bin/ssserver -c " $1".json > logs/nohup_" $1 ".out 2>&1> /dev/null &"}'|sh
				cd -
		stop-sss.sh:
				cd ~sindo/shadowsocks
				ls *.json|cut -d. -f1|cut -d/ -f5|awk  '{print "ps -ef|grep ssserver|grep -v grep|grep "$1".json"}'|sh|awk '{print $2}'|xargs kill
				cd -
		-->
		<sshexec host="${hostAddr}" username="${userName}" password="${realPswd}" trust="true"
				failonerror="false" timeout="5000" command=" " />
		
		<sshexec host="${hostAddr}" username="${userName}" password="${realPswd}" trust="true"
				outputproperty="Linux" command="
						ps -ef|grep ssserver|grep -v grep|xargs kill -9;
						cd shadowsocks; rm -fr *.json;"/>
						
		<!--
		-->
		<sshexec host="${hostAddr}" username="${userName}" password="${realPswd}" trust="true"
				outputproperty="Linux" command="
						ls *.json|cut -d. -f1|awk '{print &quot;nohup /usr/local/bin/ssserver -c &quot; $1 &quot;.json &gt; logs/nohup_&quot; $1 &quot;.out 2>&amp;1 &lt; /dev/null &amp;&quot;}'" />
	</target>
	
	<target name="kill" depends="init">
		<echo>killing userId: ${hostAddr}\${shadowName}${inputSsUser}.json</echo>
		
		<sshexec host="${hostAddr}" username="${userName}" password="${realPswd}" trust="true"
				failonerror="false" timeout="5000" command="
						ps -ef|grep ssserver|grep -v grep|grep ${shadowName}${inputSsUser}|awk '{print $2}'|xargs kill -9;" />
		
		<sshexec host="${hostAddr}" username="${userName}" password="${realPswd}" trust="true"
				outputproperty="Linux" command="
						ps -ef|grep -v grep|grep ${shadowName}{inputSsUser};
						echo +++++++++++++++++++++++++++++++++++++++++++++++++++;
						tail -n 10 shadowsocks/logs/nohup_${shadowName}${inputSsUser}.out;" />
	</target>
	
	<target name="delete" depends="init">
		<input message="removing userId: ${hostAddr}\${shadowName}${inputSsUser}.json, 你确定么?[n/y]>" addproperty="cfmRes"/>
		
		<RunIf if="cfmRes" value="y">
			<sshexec host="${hostAddr}" username="${userName}" password="${realPswd}" trust="true"
					failonerror="false" timeout="5000" command="
							ps -ef|grep ssserver|grep -v grep|grep ${shadowName}${inputSsUser}|awk '{print $2}'|xargs kill -9;
							rm -fr /home/${userName}/shadowsocks/${shadowName}${inputSsUser}.json;" />
			
			<sshexec host="${hostAddr}" username="${userName}" password="${realPswd}" trust="true"
					outputproperty="Linux" command="
							ps -ef|grep -v grep|grep ${shadowName}{inputSsUser};
							echo +++++++++++++++++++++++++++++++++++++++++++++++++++;
							tail -n 10 shadowsocks/logs/nohup_${shadowName}${inputSsUser}.out;" />
							
			<delete file="${workDir}/${hostDir}/${shadowName}${inputSsUser}.json"/>
		</RunIf>
	</target>
	
	<target name="main" depends="init">
		<echo>scping from: ${workDir}/${hostDir}/${shadowName}${inputSsUser}.json</echo>
		<!--
		<echo>scping to:   ${userName}:${realPswd}@${hostAddr}:/home/sindo/shadowsocks</echo>
		-->
		
		<scp file="${workDir}/${hostDir}/${shadowName}${inputSsUser}.json"
				todir="${userName}:${realPswd}@${hostAddr}:/home/${userName}/shadowsocks/" trust="true"/>
		
		<echo>starting remote shadowsocks server for ss${inputSsUser}</echo>
		
		<sshexec host="${hostAddr}" username="${userName}" password="${realPswd}" trust="true"
				failonerror="false" timeout="5000" command="
						ps -ef|grep ssserver|grep -v grep|grep ${shadowName}${inputSsUser}|awk '{print $2}'|xargs kill -9;
						cd shadowsocks; 
						echo mv ${shadowName}${inputSsUser}.json ${shadowName_}ss${inputSsUser}.json;
						nohup /usr/local/bin/ssserver -c ${shadowName}${inputSsUser}.json &gt;logs/nohup_${shadowName}${inputSsUser}.out 2&gt;&amp;1 &lt;/dev/null &amp;">
		</sshexec>
		
		<sshexec host="${hostAddr}" username="${userName}" password="${realPswd}" trust="true"
				outputproperty="Linux" command="
						ps -ef|grep -v grep|grep ${shadowName}${inputSsUser};
						tail -n 10 shadowsocks/logs/nohup_${shadowName}${inputSsUser}.out;">
		</sshexec>
		
		<antcall target="info" />
	</target>
</project>

